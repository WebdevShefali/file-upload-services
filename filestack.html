<!DOCTYPE html>
<html>
  <head>
    <title>Filestack Upload</title>
    <!-- Filestack JS -->
    <script src="https://static.filestackapi.com/filestack-js/4.x.x/filestack.min.js"></script>
    <style>
      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      h1 {
        font-size: 2rem;
        font-weight: 600;
        color: #222;
        margin-bottom: 20px;
        margin-top: 20px;
        text-align: center;
      }
      #upload-btn {
        padding: 10px 18px;
        background-color: blue;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: background-color 0.2s ease;
      }
      .performance-stats {
        margin-top: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 8px;
        font-family: monospace;
        max-width: 500px;
      }
      .stat-row {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Filestack Upload</h1>
      <!-- Button to trigger the picker -->
      <button id="upload-btn">Upload File</button>

      <!-- Performance stats will be shown here -->
      <div
        id="performance"
        class="performance-stats"
        style="display: none"
      ></div>
      <!-- Uploaded file preview will be shown here -->
      <div id="preview"></div>
    </div>

    <script>
      // Performance tracking variables
      let uploadStartTime, uploadEndTime, transformStartTime;

      // Initialise Filestack with your API key
      const client = filestack.init("YOUR_API_KEY");

      // Create a picker instance with options
      const picker = client.picker({
        accept: ["image/*", "video/*", ".pdf"], // Allowed file types
        maxSize: 100 * 1024 * 1024, // 100MB limit
        transformations: {
          crop: true,
          circle: true,
          rotate: true,
        },
        // Track upload start
        onFileUploadStarted: (file) => {
          uploadStartTime = performance.now();
          console.log(
            `Upload started: ${file.filename} (${(
              file.size /
              1024 /
              1024
            ).toFixed(2)} MB)`
          );
        },
        // Track upload progress
        onFileUploadProgress: (file, event) => {
          const percent = Math.round(event.totalPercent || 0);
          console.log(`Upload progress: ${percent}%`);
        },
        // Callback after each file is uploaded

        onFileUploadFinished: (result) => {
          // Calculate upload time
          uploadEndTime = performance.now();
          const uploadDuration = (
            (uploadEndTime - uploadStartTime) /
            1000
          ).toFixed(2);

          // Extract the file handle from the result
          const baseUrl = "https://cdn.filestackcontent.com";
          const resultHandle = result.handle || result.url.split("/").pop();

          // Track transformation time
          transformStartTime = performance.now();
          // Example: Apply a resize + polaroid transformation

          const transformedUrl = `${baseUrl}/resize=width:300/polaroid/${resultHandle}`;

          // Measure transformation loading
          const testImg = new Image();
          testImg.onload = function () {
            const transformDuration = (
              (performance.now() - transformStartTime) /
              1000
            ).toFixed(2);

            // Display performance stats
            document.getElementById("performance").style.display = "block";
            document.getElementById("performance").innerHTML = `
              <h3 style="margin-top: 0;">Performance Metrics</h3>
              <div class="stat-row">
                <span>File Size:</span>
                <strong>${(result.size / 1024 / 1024).toFixed(2)} MB</strong>
              </div>
              <div class="stat-row">
                <span>Upload Time:</span>
                <strong>${uploadDuration}s</strong>
              </div>
              <div class="stat-row">
                <span>Upload Speed:</span>
                <strong>${(result.size / 1024 / 1024 / uploadDuration).toFixed(
                  2
                )} MB/s</strong>
              </div>
              <div class="stat-row">
                <span>Transformation Time:</span>
                <strong>${transformDuration}s</strong>
              </div>
              <div class="stat-row">
                <span>Total Time:</span>
                <strong>${(
                  parseFloat(uploadDuration) + parseFloat(transformDuration)
                ).toFixed(2)}s</strong>
              </div>
            `;
          };
          testImg.src = transformedUrl;

          // Show both the original and the transformed file in preview
          document.getElementById("preview").innerHTML = `
            <div style="display: flex; gap: 10px; margin-top:20px; padding:10px;">
              <p><strong>Original:</strong></p>
              <img src="${result.url}" style="max-width:200px; border-radius:8px;" />
              <p><strong>Transformed:</strong></p>
              <img src="${transformedUrl}"  />
            </div>
          `;
        },
      });
      //  Open the picker when the button is clicked
      document.getElementById("upload-btn").addEventListener("click", () => {
        picker.open();
      });
    </script>
  </body>
</html>
